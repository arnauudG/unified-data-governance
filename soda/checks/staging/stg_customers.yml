# STAGING Layer - Customers Table Quality Checks
# Database: SODA_CERTIFICATION, Schema: STAGING
# Table: stg_customers (10,000+ records)
# 
# DECISION: "Is the transformation successful and can we proceed to MART?"
# RISK: Bad transformations, inconsistent data, missing required fields for downstream
# QUALITY DIMENSIONS: Schema, Validity (transformation rules), Completeness (for downstream joins), Consistency

# Dataset discovery configuration for Soda Cloud
discover datasets:
  datasets:
    - include STG_CUSTOMERS

# Soda Cloud Profiling Configuration for Partner Certification
profile columns:
  columns:
    - STG_CUSTOMERS.%
    - exclude STG_CUSTOMERS.CREATED_AT
    - exclude STG_CUSTOMERS.UPDATED_AT
    - exclude STG_CUSTOMERS.INGESTION_TIMESTAMP
    - exclude STG_CUSTOMERS.HAS_MISSING_EMAIL
    - exclude STG_CUSTOMERS.HAS_MISSING_PHONE
    - exclude STG_CUSTOMERS.HAS_MISSING_NAME

# Sample datasets configuration for Soda Cloud
sample datasets:
  datasets:
    - include STG_CUSTOMERS

checks for STG_CUSTOMERS:
  # Schema validation - structure matters for downstream
  - schema:
      name: "Staging customer table schema validation"
      attributes:
        dimension: Validity
      fail:
        when required column missing: [CUSTOMER_ID, FIRST_NAME, LAST_NAME, EMAIL, DATA_QUALITY_SCORE]
        when forbidden column present: [DUPLICATE_ID, TEST_COLUMN]
  
  # Completeness - critical for downstream joins
  - missing_count(CUSTOMER_ID) = 0:
      name: "No missing customer IDs in staging"
      attributes:
        dimension: Completeness
  
  # Validity - transformation rules
  - invalid_count(EMAIL) < 200:
      name: "Invalid email formats reduced in staging"
      valid regex: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
      attributes:
        dimension: Validity
  
  # Consistency - transformation quality indicator
  - avg(DATA_QUALITY_SCORE) > 80:
      name: "Average data quality score above 80"
      attributes:
        dimension: Consistency
